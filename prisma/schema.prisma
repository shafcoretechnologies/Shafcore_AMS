generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")   // pooler (runtime)
  directUrl = env("DIRECT_URL")     // direct (migrations)
  schemas   = ["asset"]
}

enum UserRole {
  SUPER_ADMIN
  IT_ADMIN
  IT_MANAGER
  AUDITOR

  @@schema("asset")
}

enum AssetStatus {
  IN_STOCK
  ASSIGNED
  IN_USE
  IN_REPAIR
  RETIRED
  DISPOSED
  LOST

  @@schema("asset")
}

enum ApprovalStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED

  @@schema("asset")
}

enum ApprovalAction {
  CREATE
  UPDATE
  RETIRE
  DISPOSE

  @@schema("asset")
}

enum AssignmentType {
  EMPLOYEE
  LOCATION
  BAY

  @@schema("asset")
}

model User {
  id                 String           @id @default(cuid())
  name               String
  email              String           @unique
  role               UserRole
  passwordHash       String?
  passwordUpdatedAt  DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  createdAssets      Asset[]          @relation("AssetCreatedBy")
  approvedAssets     Asset[]          @relation("AssetApprovedBy")
  requestedApprovals AssetApproval[]  @relation("ApprovalRequestedBy")
  reviewedApprovals  AssetApproval[]  @relation("ApprovalReviewedBy")
  assignmentsCreated AssetAssignment[]
  firmwareUpdates    FirmwareHistory[]
  auditLogs          AssetAuditLog[]
  sessions           UserSession[]

  @@schema("asset")
}

model UserSession {
  id         String   @id @default(cuid())
  tokenHash  String   @unique
  userId     String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  lastSeenAt DateTime @default(now())
  revokedAt  DateTime?
  ipAddress  String?
  userAgent  String?
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
  @@index([expiresAt, revokedAt])
  @@schema("asset")
}

model LoginRateLimit {
  key         String   @id
  attempts    Int      @default(0)
  windowStart DateTime @default(now())
  blockedUntil DateTime?
  updatedAt   DateTime @updatedAt

  @@schema("asset")
}

model Branch {
  id         String     @id @default(cuid())
  code       String     @unique
  name       String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  locations  Location[]
  employees  Employee[]
  assets     Asset[]
  assignment AssetAssignment[]

  @@schema("asset")
}

model Location {
  id          String   @id @default(cuid())
  branchId    String
  name        String
  floor       String?
  roomCode    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Restrict)
  bays        Bay[]
  assets      Asset[]
  assignments AssetAssignment[]

  @@index([branchId, name])
  @@schema("asset")
}

model Bay {
  id         String   @id @default(cuid())
  locationId String
  code       String
  description String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  location   Location @relation(fields: [locationId], references: [id], onDelete: Restrict)
  assets     Asset[]
  assignments AssetAssignment[]

  @@unique([locationId, code])
  @@index([code])
  @@schema("asset")
}

model Employee {
  id                String   @id @default(cuid())
  branchId          String
  employeeCode      String
  name              String
  email             String?
  department        String?
  designation       String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  branch            Branch   @relation(fields: [branchId], references: [id], onDelete: Restrict)
  currentAssets     Asset[]
  assignmentHistory AssetAssignment[]

  @@unique([branchId, employeeCode])
  @@index([name])
  @@schema("asset")
}

model AssetType {
  id             String   @id @default(cuid())
  name           String   @unique
  requiresSerial Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  models         AssetModel[]
  assets         Asset[]

  @@schema("asset")
}

model AssetModel {
  id                    String   @id @default(cuid())
  assetTypeId           String
  manufacturer          String
  modelName             String
  specs                 Json?
  defaultWarrantyMonths Int?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  assetType             AssetType @relation(fields: [assetTypeId], references: [id], onDelete: Restrict)
  assets                Asset[]

  @@unique([assetTypeId, manufacturer, modelName])
  @@schema("asset")
}

model Asset {
  id                   String   @id @default(cuid())
  assetTag             String   @unique
  assetTypeId          String
  assetModelId         String?
  branchId             String
  locationId           String?
  bayId                String?
  currentEmployeeId    String?
  status               AssetStatus @default(IN_STOCK)
  serialNumber         String?
  warrantyExpiry       DateTime?
  warrantyMonths       Int?
  firmwareVersion      String?
  purchaseDate         DateTime?
  vendorName           String?
  invoiceNumber        String?
  invoiceDate          DateTime?
  invoiceAmount        Decimal? @db.Decimal(12, 2)
  invoiceFileUrl       String?
  serviceTag           String?
  osVersion            String?
  processorDetails     String?
  make                 String?
  model                String?
  adapterTagNumber     String?
  floor                String?
  repairAction         String?
  replacementForAssetId String?
  specification        Json?
  notes                String?
  approvalStatus       ApprovalStatus @default(PENDING)
  createdById          String
  approvedById         String?
  parentAssetId        String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  assetType            AssetType  @relation(fields: [assetTypeId], references: [id], onDelete: Restrict)
  assetModel           AssetModel? @relation(fields: [assetModelId], references: [id], onDelete: SetNull)
  branch               Branch     @relation(fields: [branchId], references: [id], onDelete: Restrict)
  location             Location?  @relation(fields: [locationId], references: [id], onDelete: SetNull)
  bay                  Bay?       @relation(fields: [bayId], references: [id], onDelete: SetNull)
  currentEmployee      Employee?  @relation(fields: [currentEmployeeId], references: [id], onDelete: SetNull)
  createdBy            User       @relation("AssetCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  approvedBy           User?      @relation("AssetApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  parentAsset          Asset?     @relation("AssetBundle", fields: [parentAssetId], references: [id], onDelete: SetNull)
  childAssets          Asset[]    @relation("AssetBundle")
  replacementForAsset  Asset?     @relation("AssetReplacement", fields: [replacementForAssetId], references: [id], onDelete: SetNull)
  replacedByAssets     Asset[]    @relation("AssetReplacement")
  approvals            AssetApproval[]
  assignments          AssetAssignment[]
  firmwareHistory      FirmwareHistory[]
  auditLogs            AssetAuditLog[]

  @@index([branchId, locationId, bayId])
  @@schema("asset")
}

model AssetAssignment {
  id            String   @id @default(cuid())
  assetId       String
  assignmentType AssignmentType
  branchId      String?
  locationId    String?
  bayId         String?
  employeeId    String?
  assignedById  String
  assignedAt    DateTime @default(now())
  unassignedAt  DateTime?
  remarks       String?
  asset         Asset    @relation(fields: [assetId], references: [id], onDelete: Restrict)
  branch        Branch?  @relation(fields: [branchId], references: [id], onDelete: SetNull)
  location      Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  bay           Bay?     @relation(fields: [bayId], references: [id], onDelete: SetNull)
  employee      Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  assignedBy    User     @relation(fields: [assignedById], references: [id], onDelete: Restrict)

  @@index([assetId, assignedAt])
  @@schema("asset")
}

model AssetApproval {
  id            String   @id @default(cuid())
  assetId       String
  action        ApprovalAction
  status        ApprovalStatus @default(PENDING)
  requestedById String
  reviewedById  String?
  reason        String?
  snapshot      Json?
  requestedAt   DateTime @default(now())
  reviewedAt    DateTime?
  asset         Asset @relation(fields: [assetId], references: [id], onDelete: Restrict)
  requestedBy   User  @relation("ApprovalRequestedBy", fields: [requestedById], references: [id], onDelete: Restrict)
  reviewedBy    User? @relation("ApprovalReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)

  @@schema("asset")
}

model FirmwareHistory {
  id          String   @id @default(cuid())
  assetId     String
  updatedById String
  version     String
  updatedAt   DateTime @default(now())
  notes       String?
  asset       Asset @relation(fields: [assetId], references: [id], onDelete: Restrict)
  updatedBy   User  @relation(fields: [updatedById], references: [id], onDelete: Restrict)

  @@schema("asset")
}

model AssetAuditLog {
  id        String   @id @default(cuid())
  assetId   String
  actorId   String
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())
  asset     Asset @relation(fields: [assetId], references: [id], onDelete: Restrict)
  actor     User  @relation(fields: [actorId], references: [id], onDelete: Restrict)

  @@schema("asset")
}